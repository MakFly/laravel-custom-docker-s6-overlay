#!/command/with-contenv bash

# Palette de couleurs harmonis√©e
COLOR_INFO='\033[1;36m'    # Cyan clair
COLOR_SUCCESS='\033[1;32m' # Vert vif
COLOR_WARN='\033[1;33m'    # Jaune
COLOR_ERROR='\033[1;31m'   # Rouge vif
COLOR_CMD='\033[1;35m'     # Violet
NC='\033[0m' # No Color

# Explication sur le red√©marrage en production :
# En production, le worker doit tourner en continu. S'il s'arr√™te (crash, OOM, etc.),
# c'est le process manager (ici s6-overlay) qui doit le relancer automatiquement.
# Il ne faut pas forcer de red√©marrage fr√©quent en production :
# - Utiliser des limites raisonnables (--max-time, --memory) pour √©viter les fuites m√©moire.
# - Surveiller les logs pour d√©tecter les crashs anormaux.
# - Adapter la configuration selon la charge r√©elle.

# Affichage d√©marrage
echo -e "${COLOR_INFO}üöÄ D√©marrage du service Laravel Queue Worker...${NC}"

# V√©rifier si le service worker doit √™tre activ√©
if [ "$ENABLE_WORKER" != "true" ]; then
    echo -e "${COLOR_WARN}‚ö†Ô∏è  Worker service d√©sactiv√©. Arr√™t du service.${NC}"
    exit 0
fi

# D√©finir le r√©pertoire de travail
cd /app

# V√©rifier si Laravel est install√© et accessible
if ! php artisan --version > /dev/null 2>&1; then
    echo -e "${COLOR_ERROR}‚ùå Laravel n'est pas accessible. V√©rifiez l'installation.${NC}"
    exit 1
fi

echo -e "${COLOR_SUCCESS}‚úÖ Laravel d√©tect√©. D√©marrage du queue worker...${NC}"

# Configuration selon l'environnement
if [ "$APP_ENV" = "production" ]; then
    echo -e "${COLOR_INFO}üè≠ Mode production : worker avec limites de s√©curit√©${NC}"
    WORKER_CMD="php artisan queue:work --sleep=3 --tries=3 --max-time=3600 --memory=512"
else
    echo -e "${COLOR_INFO}üîß Mode d√©veloppement : worker avec red√©marrage fr√©quent${NC}"
    WORKER_CMD="php artisan queue:work --sleep=3 --tries=3 --max-time=1800 --memory=256"
fi

# Configuration des queues sp√©cifiques si d√©finies
if [ -n "$QUEUE_NAMES" ]; then
    WORKER_CMD="$WORKER_CMD --queue=$QUEUE_NAMES"
    echo -e "${COLOR_INFO}üìã Queues configur√©es : $QUEUE_NAMES${NC}"
fi

# Lancer le worker avec gestion des signaux
echo -e "${COLOR_CMD}‚ñ∂Ô∏è  Commande : $WORKER_CMD${NC}"
exec $WORKER_CMD