#!/command/with-contenv bash

# Palette de couleurs harmonis√©e
COLOR_INFO='\033[1;36m'    # Cyan clair
COLOR_SUCCESS='\033[1;32m' # Vert vif
COLOR_WARN='\033[1;33m'    # Jaune
COLOR_ERROR='\033[1;31m'   # Rouge vif
COLOR_CMD='\033[1;35m'     # Violet
NC='\033[0m' # No Color

# Affichage d√©marrage
echo -e "${COLOR_INFO}üöÄ D√©marrage du service Laravel Horizon...${NC}"

# V√©rifier si Horizon doit √™tre activ√©
if [ "$ENABLE_HORIZON" != "true" ]; then
    echo -e "${COLOR_WARN}‚ö†Ô∏è  Horizon service d√©sactiv√©. Arr√™t du service.${NC}"
    exit 0
fi

# D√©finir le r√©pertoire de travail
cd /app

# V√©rifier si Laravel est install√© et accessible
if ! php artisan --version > /dev/null 2>&1; then
    echo -e "${COLOR_ERROR}‚ùå Laravel n'est pas accessible. V√©rifiez l'installation.${NC}"
    exit 1
fi

# V√©rifier si Horizon est install√©
if ! php artisan horizon:list > /dev/null 2>&1; then
    echo -e "${COLOR_ERROR}‚ùå Laravel Horizon n'est pas install√© ou configur√©.${NC}"
    exit 1
fi

# V√©rifier la connexion Redis (requise pour Horizon)
if ! php artisan tinker --execute="try { \Illuminate\Support\Facades\Redis::ping(); echo 'Redis OK'; } catch(\Exception \$e) { echo 'Redis Error: ' . \$e->getMessage(); exit(1); }" > /dev/null 2>&1; then
    echo -e "${COLOR_ERROR}‚ùå Redis n'est pas accessible. Horizon n√©cessite Redis.${NC}"
    exit 1
fi

echo -e "${COLOR_SUCCESS}‚úÖ Laravel et Redis d√©tect√©s. D√©marrage d'Horizon...${NC}"

# Configuration selon l'environnement
if [ "$APP_ENV" = "production" ]; then
    echo -e "${COLOR_INFO}üè≠ Mode production : Horizon avec configuration optimis√©e${NC}"
else
    echo -e "${COLOR_INFO}üîß Mode d√©veloppement : Horizon avec monitoring actif${NC}"
fi

# Nettoyer les anciens processus Horizon (si pr√©sents)
echo -e "${COLOR_INFO}üßπ Nettoyage des anciens processus Horizon...${NC}"
php artisan horizon:terminate 2>/dev/null || true

# Attendre que les processus se terminent proprement
sleep 2

# Lancer Horizon
echo -e "${COLOR_CMD}‚ñ∂Ô∏è  D√©marrage: php artisan horizon${NC}"
echo -e "${COLOR_SUCCESS}üåü Horizon dashboard accessible sur /horizon${NC}"

# Ex√©cuter Horizon avec gestion des signaux
exec php artisan horizon 